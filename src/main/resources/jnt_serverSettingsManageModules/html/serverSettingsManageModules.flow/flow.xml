<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
		http://www.springframework.org/schema/webflow
		http://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <var name="flowHandler" class="org.jahia.modules.serversettings.flow.ModuleManagementFlowHandler"/>

    <view-state id="view" model="moduleFile">
        <on-entry>
            <evaluate expression="flowHandler.initModuleFile()" result="flowScope.moduleFile"/>
        </on-entry>
        <on-render>
            <evaluate expression="JahiaTemplateManagerService.templatePackageRegistry.allModuleVersions"
                      result="requestScope.allModuleVersions"/>
            <evaluate expression="JahiaTemplateManagerService.templatePackageRegistry.registeredModules"
                      result="requestScope.registeredModules"/>
        </on-render>

        <transition on="downloadSources" to="viewDownloadForm">
            <set value="requestParameters.currentModule" name="flowScope.currentModule"/>
            <set value="requestParameters.scmUri" name="flowScope.scmUri"/>
        </transition>

        <transition on="startModule" to="startModule"/>
        <transition on="stopModule" to="stopModule"/>


        <transition on="upload" to="view">
            <evaluate expression="flowHandler.uploadModule(moduleFile, messageContext)"/>
        </transition>

        <transition on="viewDetails" to="detailedView"/>
    </view-state>

    <view-state id="viewDownloadForm" model="flowScope">

        <transition on="downloadSources" to="downloadSources"/>
    </view-state>

    <view-state id="detailedView">
        <on-entry>
            <evaluate expression="requestParameters.selectedModule?:flowScope.selectedModule" result="flowScope.selectedModule"/>
        </on-entry>
        <on-render>
            <evaluate expression="flowHandler.loadModuleInformation(flowRequestContext)" result="requestScope.detailedModule"/>
        </on-render>
        <transition on="startModule" to="startModule"/>
        <transition on="stopModule" to="stopModule"/>
        <transition on="downloadSources" to="viewDownloadForm">
            <set value="requestParameters.module" name="flowScope.currentModule"/>
            <set value="requestParameters.scmUri" name="flowScope.scmUri"/>
        </transition>
        <transition on="viewDetails" to="detailedView"/>
        <transition on="deploy" to="deployToSite"/>
        <transition on="undeploy" to="undeployFromSite"/>
    </view-state>

    <action-state id="downloadSources">
        <evaluate
                expression="JahiaTemplateManagerService.checkoutModule(null,flowScope.scmUri, null,flowScope.module,null,jcrSessionFactory.currentUserSession)"/>
        <transition on-exception="java.lang.Exception" to="viewDownloadForm">
            <set name="flashScope.error" value="'serverSettings.manageModules.downloadSourcesError'"/>
        </transition>
        <transition to="sourcesDownloaded"/>
    </action-state>

    <end-state id="sourcesDownloaded"/>

    <action-state id="startModule">
        <evaluate
                expression="JahiaTemplateManagerService.activateModuleVersion(requestParameters.module,requestParameters.version)"/>
        <transition to="moduleStarted"/>
    </action-state>

    <end-state id="moduleStarted"/>

    <action-state id="stopModule">
        <evaluate expression="JahiaTemplateManagerService.stopModule(requestParameters.module)"/>
        <transition to="moduleStopped"/>
    </action-state>

    <end-state id="moduleStopped"/>

    <action-state id="deployToSite">
        <evaluate
                expression="JahiaTemplateManagerService.installModule(requestParameters.module,requestParameters.deployTo,null)"/>
        <transition on-exception="java.lang.Exception" to="detailedView">
            <set name="flashScope.error" value="'serverSettings.manageModules.modules.deploy.error'"/>
        </transition>
        <transition to="detailedView"/>
    </action-state>

    <action-state id="undeployFromSite">
        <evaluate
                expression="JahiaTemplateManagerService.uninstallModules(JahiaTemplateManagerService.getTemplatePackage(requestParameters.module),requestParameters.undeployFrom,jcrSessionFactory.currentUserSession)"/>
        <transition on-exception="java.lang.Exception" to="detailedView">
            <set name="flashScope.error" value="'serverSettings.manageModules.modules.undeploy.error'"/>
        </transition>
        <transition to="detailedView"/>
    </action-state>
</flow>
