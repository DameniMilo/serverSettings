<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
		http://www.springframework.org/schema/webflow
		http://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <var name="flowHandler" class="org.jahia.modules.serversettings.flow.ModuleManagementFlowHandler"/>

    <on-start>
        <evaluate expression="flowHandler.initModules()" />
    </on-start>

    <decision-state id="moreAnswersNeeded">
        <if test="flowHandler.isInModule(externalContext.requestMap.renderContext)" then="detailedView" else="view" />
    </decision-state>

    <view-state id="view" model="moduleFile">
        <on-entry>
            <evaluate expression="flowHandler.initModuleFile()" result="flowScope.moduleFile"/>
        </on-entry>
        <on-render>
            <evaluate expression="flowHandler.allModuleVersions"
                      result="requestScope.allModuleVersions"/>
            <evaluate expression="flowHandler.availableUpdates"
                      result="requestScope.availableUpdates"/>
            <evaluate expression="JahiaTemplateManagerService.templatePackageRegistry.registeredModules"
                      result="requestScope.registeredModules"/>
            <evaluate expression="JahiaTemplateManagerService.sourceControlFactory.supportedSourceControls"
                      result="requestScope.sourceControls"/>
            <evaluate expression="flowHandler.populateSitesInformation(flowRequestContext)" />
        </on-render>

        <transition on="viewDownloadForm" to="viewDownloadForm">
            <set value="requestParameters.currentModule" name="flowScope.currentModule"/>
            <set value="requestParameters.scmUri" name="flowScope.scmUri"/>
        </transition>

        <transition on="downloadSources" to="downloadSources"/>


        <transition on="startModule" to="startModule"/>
        <transition on="stopModule" to="stopModule"/>
        <transition on="undeployModule" to="undeployModule"/>


        <transition on="upload" to="view">
            <evaluate expression="flowHandler.uploadModule(moduleFile, messageContext)"/>
        </transition>

        <transition on="installModule" to="view">
            <evaluate expression="flowHandler.installModule(requestParameters.forgeId, requestParameters.moduleUrl, messageContext)"/>
        </transition>

        <transition on="viewDetails" to="detailedView"/>
    </view-state>

    <view-state id="viewDownloadForm" model="flowScope">

        <transition on="downloadSources" to="downloadSources"/>
    </view-state>

    <view-state id="detailedView">
        <on-entry>
            <evaluate expression="requestParameters.selectedModule?:flowScope.selectedModule" result="flowScope.selectedModule"/>
        </on-entry>
        <on-render>
            <evaluate expression="flowHandler.loadModuleInformation(flowRequestContext)" result="requestScope.detailedModule"/>
            <evaluate expression="JahiaTemplateManagerService.sourceControlFactory.supportedSourceControls"
                      result="requestScope.sourceControls"/>
        </on-render>
        <transition on="startModule" to="startModule"/>
        <transition on="stopModule" to="stopModule"/>
        <transition on="downloadSources" to="downloadSources">
            <set value="requestParameters.module" name="flowScope.currentModule"/>
            <set value="requestParameters.scmUri" name="flowScope.scmUri"/>
        </transition>
        <transition on="viewDetails" to="detailedView"/>
        <transition on="enable" to="enableOnSite"/>
        <transition on="disable" to="disableFromSite"/>
        <transition on="disableAll" to="disableFromAllSites"/>
    </view-state>

    <action-state id="downloadSources">
        <on-entry>
            <evaluate expression="requestParameters.scmUri?:flowScope.scmUri" result="flowScope.scmUri"/>
            <evaluate expression="requestParameters.module?:flowScope.module" result="flowScope.module"/>
        </on-entry>
        <evaluate
                expression="JahiaTemplateManagerService.checkoutModule(null,flowScope.scmUri, null,flowScope.module,null,jcrSessionFactory.currentUserSession)"/>
        <transition on-exception="java.lang.Exception" to="viewDownloadForm">
            <set name="flashScope.error" value="'serverSettings.manageModules.downloadSourcesError'"/>
            <evaluate expression="flowHandler.logError(rootCauseException)"/>
        </transition>
        <transition to="sourcesDownloaded"/>
    </action-state>

    <end-state id="sourcesDownloaded"/>

    <action-state id="startModule">
        <evaluate
                expression="JahiaTemplateManagerService.activateModuleVersion(requestParameters.module,requestParameters.version)"/>
        <transition to="moduleStarted"/>
    </action-state>

    <end-state id="moduleStarted"/>

    <action-state id="stopModule">
        <evaluate expression="JahiaTemplateManagerService.stopModule(requestParameters.module)"/>
        <transition to="moduleStopped"/>
    </action-state>

    <end-state id="moduleStopped"/>

    <action-state id="undeployModule">
        <evaluate expression="JahiaTemplateManagerService.undeployModule(requestParameters.module,requestParameters.version)"/>
        <transition to="view"/>
    </action-state>

    <action-state id="enableOnSite">
        <evaluate
                expression="JahiaTemplateManagerService.installModule(requestParameters.module,requestParameters.enableOn,null)"/>
        <transition on-exception="java.lang.Exception" to="detailedView">
            <set name="flashScope.error" value="'serverSettings.manageModules.module.enable.error'"/>
            <evaluate expression="flowHandler.logError(rootCauseException)"/>
        </transition>
        <transition to="detailedView"/>
    </action-state>

    <action-state id="disableFromSite">
        <evaluate
                expression="JahiaTemplateManagerService.uninstallModule(requestParameters.module,requestParameters.disableFrom,null,requestParameters.purge)"/>
        <transition on-exception="java.lang.Exception" to="detailedView">
            <set name="flashScope.error" value="'serverSettings.manageModules.module.disable.error'"/>
            <evaluate expression="flowHandler.logError(rootCauseException)"/>
        </transition>
        <transition to="detailedView"/>
    </action-state>

    <action-state id="disableFromAllSites">
        <evaluate
                expression="JahiaTemplateManagerService.uninstallModulesFromAllSites(requestParameters.module,null,requestParameters.purge)"/>
        <transition on-exception="java.lang.Exception" to="detailedView">
            <set name="flashScope.error" value="'serverSettings.manageModules.module.undeploy.error'"/>
            <evaluate expression="flowHandler.logError(rootCauseException)"/>
        </transition>
        <transition to="detailedView"/>
    </action-state>
</flow>
